version: 2.1
description: |
    A CircleCI orb for setting up site to site connectivity via CircleCI tunnels to enable secure access to private repositories and resources
display:
    home_url: https://circleci.com/docs/
    source_url: https://github.com/CircleCI-Labs/site-to-site-connectivity-orb
commands:
    checkout:
        description: |
            Checkout code from a private repository via CircleCI tunnel
        parameters:
            checkout-depth:
                description: Depth to pass to `git clone` command as `--depth` parameter
                type: integer
            checkout-folder:
                default: ~/project
                description: Folder to checkout the repository into
                type: string
            debug:
                default: false
                description: Enable debug mode
                type: boolean
            git-url:
                description: Git URL to the repository
                type: string
            tunnel-address:
                default: TUNNEL_ADDRESS
                description: |
                    Environment variable name containing the tunnel address for the CircleCI tunnel
                type: env_var_name
            tunnel-port:
                default: TUNNEL_PORT
                description: |
                    Environment variable name containing the tunnel port for the CircleCI tunnel
                type: env_var_name
        steps:
            - run:
                command: |
                    #!/bin/bash

                    set -eu -o pipefail

                    # Check if environment variables are set
                    missing=0

                    # Resolve indirect values (PARAM_* contains the variable name to read)
                    resolved_tunnel_address="${!PARAM_TUNNEL_ADDRESS:-}"
                    resolved_tunnel_port="${!PARAM_TUNNEL_PORT:-}"

                    if [ -z "${resolved_tunnel_address}" ]; then
                      echo "Error: ${PARAM_TUNNEL_ADDRESS} is not set or empty"
                      missing=1
                    fi
                    if [ -z "${resolved_tunnel_port}" ]; then
                      echo "Error: ${PARAM_TUNNEL_PORT} is not set or empty"
                      missing=1
                    fi
                    if [ -z "${GIT_URL:-}" ]; then
                      echo "Error: GIT_URL is not set or empty"
                      missing=1
                    fi
                    if [ -z "${CHECKOUT_FOLDER:-}" ]; then
                      echo "Error: CHECKOUT_FOLDER is not set or empty"
                      missing=1
                    fi
                    if [ "$missing" -ne 0 ]; then
                      exit 1
                    fi

                    # Extract the repository path from the Git URL
                    echo "Extracting repository path from Git URL: ${GIT_URL}"
                    REPO_PATH="${GIT_URL#*:}"

                    if [[ -n "${DEBUG:-}" ]]; then
                      echo "DEBUG REPO_PATH: ${REPO_PATH}"
                    fi

                    REPO_URL="ssh://git@${resolved_tunnel_address}:${resolved_tunnel_port}/${REPO_PATH}"
                    echo "Constructed repository URL: ${REPO_URL}"

                    # Create the SSH directory if it doesn't exist
                    mkdir ~/.ssh || true

                    # Scan the SSH key for the repository
                    ssh-keyscan -p "${resolved_tunnel_port}" "${resolved_tunnel_address}" >> ~/.ssh/known_hosts

                    # Clone the repository
                    echo "Cloning repository from: ${REPO_URL} into: ${CHECKOUT_FOLDER}"

                    # Determine git history depth or unlimited
                    depth_arg=""
                    if [ -n "${CHECKOUT_DEPTH:-}" ]; then
                      depth_arg="--depth ${CHECKOUT_DEPTH}"
                    fi

                    # Determine what to clone (branch or tag)
                    if [ -n "${CIRCLE_BRANCH:-}" ]; then
                      echo "Cloning branch: ${CIRCLE_BRANCH}"
                      GIT_TERMINAL_PROMPT=0 git clone --branch ${CIRCLE_BRANCH} --single-branch ${depth_arg} "$REPO_URL" "${CHECKOUT_FOLDER}"
                    elif [ -n "${CIRCLE_TAG:-}" ]; then
                      echo "Cloning tag: ${CIRCLE_TAG}"
                      GIT_TERMINAL_PROMPT=0 git clone --branch ${CIRCLE_TAG} --single-branch ${depth_arg} "$REPO_URL" "${CHECKOUT_FOLDER}"
                    else
                      echo "Error: Neither CIRCLE_BRANCH nor CIRCLE_TAG is set"
                      exit 1
                    fi

                    echo "Repository cloned successfully."
                environment:
                    CHECKOUT_DEPTH: << parameters.checkout-depth >>
                    CHECKOUT_FOLDER: << parameters.checkout-folder >>
                    DEBUG: << parameters.debug >>
                    GIT_URL: << parameters.git-url >>
                    PARAM_TUNNEL_ADDRESS: << parameters.tunnel-address >>
                    PARAM_TUNNEL_PORT: << parameters.tunnel-port >>
                name: Clone repo
    cleanup:
        description: |
            Cleanup CircleCI tunnel and remove IP policy rules
        parameters:
            debug:
                default: false
                description: Enable debug mode
                type: boolean
            ngrok-api-token:
                default: NGROK_API_TOKEN
                description: Environment variable name containing the Ngrok API token
                type: env_var_name
        steps:
            - run:
                command: |
                    #!/bin/bash

                    set -eu -o pipefail

                    # Check if environment variables are set
                    missing=0

                    # Resolve indirect values (PARAM_* contains the variable name to read)
                    resolved_ngrok_api_token="${!PARAM_NGROK_API_TOKEN:-}"

                    if [ -z "${resolved_ngrok_api_token}" ]; then
                      echo "Error: ${PARAM_NGROK_API_TOKEN} is not set or empty"
                      missing=1
                    fi
                    if [ -z "${IPR_ID:-}" ]; then
                      echo "Error: IPR_ID is not set or empty"
                      missing=1
                    fi
                    if [ "$missing" -ne 0 ]; then
                      exit 1
                    fi

                    echo "Cleaning up CircleCI tunnel with IPR_ID: ${IPR_ID}"

                    if [[ -n "${DEBUG:-}" ]]; then
                      echo "DEBUG curl command:"
                      echo curl -H 'Accept: application/json' \
                        -H "Authorization: Bearer ${resolved_ngrok_api_token}" \
                        -H "Content-Type: application/json" \
                        -H "Ngrok-Version: 2" \
                        -X DELETE \
                        --fail \
                        "https://api.ngrok.com/ip_policy_rules/${IPR_ID}"
                    fi

                    curl -H 'Accept: application/json' \
                      -H "Authorization: Bearer ${resolved_ngrok_api_token}" \
                      -H "Content-Type: application/json" \
                      -H "Ngrok-Version: 2" \
                      -X DELETE \
                      --fail \
                      "https://api.ngrok.com/ip_policy_rules/${IPR_ID}"

                    echo "CircleCI tunnel cleanup complete"
                environment:
                    DEBUG: << parameters.debug >>
                    PARAM_NGROK_API_TOKEN: << parameters.ngrok-api-token >>
                name: Cleanup tunnel
                when: always
    setup:
        description: |
            Setup CircleCI tunnel for site to site connectivity
        parameters:
            debug:
                default: false
                description: Enable debug mode
                type: boolean
            ip-policy-id:
                default: IP_POLICY_ID
                description: |
                    Environment variable name containing the IP policy ID for the CircleCI tunnel
                type: env_var_name
            ngrok-api-token:
                default: NGROK_API_TOKEN
                description: Environment variable name containing the Ngrok API token
                type: env_var_name
            tunnel-address:
                default: TUNNEL_ADDRESS
                description: |
                    Environment variable name containing the tunnel address for the CircleCI tunnel
                type: env_var_name
            tunnel-port:
                default: TUNNEL_PORT
                description: |
                    Environment variable name containing the tunnel port for the CircleCI tunnel
                type: env_var_name
            verify-tunnel:
                default: true
                description: Verify the connection before exiting
                type: boolean
            verify-tunnel-attempts:
                default: 30
                description: Number of attempts before failing to verify the tunnel
                type: integer
        steps:
            - run:
                command: |
                    #!/bin/bash

                    set -eu -o pipefail

                    # Check if environment variables are set
                    missing=0

                    # Resolve indirect values (PARAM_* contains the variable name to read)
                    resolved_ngrok_api_token="${!PARAM_NGROK_API_TOKEN:-}"
                    resolved_ip_policy_id="${!PARAM_IP_POLICY_ID:-}"
                    resolved_tunnel_address="${!PARAM_TUNNEL_ADDRESS:-}"
                    resolved_tunnel_port="${!PARAM_TUNNEL_PORT:-}"

                    # Validate resolved values are non-empty
                    if [ -z "${resolved_ngrok_api_token}" ]; then
                      echo "Error: ${PARAM_NGROK_API_TOKEN} is not set or empty"
                      missing=1
                    fi
                    if [ -z "${resolved_ip_policy_id}" ]; then
                      echo "Error: ${PARAM_IP_POLICY_ID} is not set or empty"
                      missing=1
                    fi
                    if [ -z "${resolved_tunnel_address}" ]; then
                      echo "Error: ${PARAM_TUNNEL_ADDRESS} is not set or empty"
                      missing=1
                    fi
                    if [ -z "${resolved_tunnel_port}" ]; then
                      echo "Error: ${PARAM_TUNNEL_PORT} is not set or empty"
                      missing=1
                    fi
                    if [ "$missing" -ne 0 ]; then
                      exit 1
                    fi

                    tunnel_file="$(mktemp)"
                    ip="$(curl --fail https://checkip.amazonaws.com/)"

                    echo "Setting up the CircleCI tunnel with IP: $ip"

                    if [[ "$(uname -s)" == "Darwin" ]]; then
                      echo "macOS detected, installing coreutils..."
                      brew install coreutils
                    else
                      echo "Non-macOS system detected, skipping coreutils installation"
                    fi

                    if [[ -n "${DEBUG:-}" ]]; then
                      echo "DEBUG curl command:"
                      echo curl -H 'Accept: application/json' \
                        -H "Authorization: Bearer ${resolved_ngrok_api_token}" \
                        -H "Content-Type: application/json" \
                        -H "Ngrok-Version: 2" \
                        -d '{"action":"allow","cidr":"'"${ip}"'/32","description":"'"$CIRCLE_BUILD_URL"'","ip_policy_id":"'"${resolved_ip_policy_id}"'"}' \
                        --fail -o "$tunnel_file" \
                        "https://api.ngrok.com/ip_policy_rules"

                      dp_file="$(mktemp)"
                      echo "dp_file: ${dp_file}"
                      curl -H 'Accept: application/json' \
                        -H "Authorization: Bearer ${resolved_ngrok_api_token}" \
                        -H "Ngrok-Version: 2" \
                        --fail -o "$dp_file" \
                        "https://api.ngrok.com/endpoints?limit=10"
                        cat ${dp_file} | base64
                        echo ""
                    fi

                    curl -H 'Accept: application/json' \
                      -H "Authorization: Bearer ${resolved_ngrok_api_token}" \
                      -H "Content-Type: application/json" \
                      -H "Ngrok-Version: 2" \
                      -d '{"action":"allow","cidr":"'"${ip}"'/32","description":"'"$CIRCLE_BUILD_URL"'","ip_policy_id":"'"${resolved_ip_policy_id}"'"}' \
                      --fail -o "$tunnel_file" \
                      "https://api.ngrok.com/ip_policy_rules"

                    if [[ -n "${PARAM_VERIFY_TUNNEL:-}" ]]; then
                      echo "Verifying the connection before exiting"
                      verified=0
                      for i in $(seq 1 ${PARAM_VERIFY_TUNNEL_ATTEMPTS:-}); do
                        echo "Attempt $i"
                        set +e +o pipefail
                        timeout 1s nc -v "${resolved_tunnel_address}" "${resolved_tunnel_port}"
                        # When timeout is reached the connection is not immediately closed and we can assume the connection is working
                        if [[ $? -eq 124 ]]; then
                          echo "Connection verified"
                          verified=1
                          break
                        fi
                        set -e -o pipefail
                        sleep 3
                        echo "Connection not verified, retrying..."
                      done
                      if [[ $verified -eq 0 ]]; then
                        echo "Connection not verified after 30 attempts"
                        exit 1
                      fi
                    fi

                    echo "Exporting IPR_ID to environment"
                    echo "export IPR_ID=\"$(jq -r '.id' "$tunnel_file")\"" >> "$BASH_ENV"
                    echo "Sourcing BASH_ENV to update the environment"
                    # shellcheck source=/dev/null
                    source "$BASH_ENV"

                    if [[ -n "${DEBUG:-}" ]]; then
                      echo "DEBUG IPR_ID: ${IPR_ID}"
                      echo "DEBUG endpoints:"
                      cat ${dp_file} | base64
                    fi

                    echo "The CircleCI tunnel setup is complete"
                environment:
                    DEBUG: << parameters.debug >>
                    PARAM_IP_POLICY_ID: << parameters.ip-policy-id >>
                    PARAM_NGROK_API_TOKEN: << parameters.ngrok-api-token >>
                    PARAM_TUNNEL_ADDRESS: << parameters.tunnel-address >>
                    PARAM_TUNNEL_PORT: << parameters.tunnel-port >>
                    PARAM_VERIFY_TUNNEL: << parameters.verify-tunnel >>
                    PARAM_VERIFY_TUNNEL_ATTEMPTS: << parameters.verify-tunnel-attempts >>
                name: Setup the CircleCI tunnel
examples:
    site_to_site_workflow:
        description: |
            Example workflow demonstrating how to use the site to site connectivity orb to access private repositories via CircleCI tunnel.
        usage:
            version: "2.1"
            workflows: null

